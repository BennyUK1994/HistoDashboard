<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Histology Block Tracking Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --success-color: #4cc9f0;
            --light-bg: #f8f9fa;
            --dark-bg: #212529;
            --light-text: #f8f9fa;
            --dark-text: #212529;
        }
        
        body {
            transition: background-color 0.3s ease, color 0.3s ease;
            padding-top: 60px;
        }
        
        body.dark-mode {
            background-color: var(--dark-bg);
            color: var(--light-text);
        }
        
        body.light-mode {
            background-color: var(--light-bg);
            color: var(--dark-text);
        }
        
        .dark-mode .card {
            background-color: #343a40;
            color: var(--light-text);
        }
        
        .dark-mode .form-control, .dark-mode .form-select {
            background-color: #495057;
            color: var(--light-text);
            border-color: #6c757d;
        }
        
        .dashboard-card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            height: 100%;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        
        .progress-bar {
            height: 10px;
            border-radius: 5px;
            transition: width 1s ease-in-out;
        }
        
        .leaderboard-item {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 5px;
            transition: background-color 0.3s ease;
        }
        
        .leaderboard-item:hover {
            background-color: rgba(67, 97, 238, 0.1);
        }
        
        .milestone-alert {
            position: fixed;
            top: 70px;
            right: 20px;
            z-index: 1050;
            min-width: 300px;
            display: none;
        }
        
        .goal-progress {
            height: 10px;
            border-radius: 5px;
        }
        
        @media (max-width: 768px) {
            .dashboard-card {
                margin-bottom: 20px;
            }
        }
        
        .nav-tabs .nav-link {
            color: var(--primary-color);
        }
        
        .nav-tabs .nav-link.active {
            color: var(--dark-text);
            font-weight: bold;
        }
        
        .dark-mode .nav-tabs .nav-link {
            color: var(--success-color);
        }
        
        .dark-mode .nav-tabs .nav-link.active {
            color: var(--light-text);
            background-color: #343a40;
            border-color: #6c757d #6c757d #343a40;
        }
    </style>
</head>
<body class="light-mode">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg fixed-top" id="mainNav">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-microscope me-2"></i>
                Histology Block Tracker
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#staffManagementModal">Manage Staff</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#importExportModal">Import/Export</a>
                    </li>
                </ul>
                <div class="d-flex">
                    <div class="form-check form-switch me-3 mt-2">
                        <input class="form-check-input" type="checkbox" id="darkModeToggle">
                        <label class="form-check-label" for="darkModeToggle">
                            <i class="fas fa-moon"></i>
                        </label>
                    </div>
                    <select class="form-select me-2" id="staffSelector" aria-label="Staff Selector">
                        <option value="all" selected>All Staff</option>
                    </select>
                    <select class="form-select me-2" id="timeRangeSelector" aria-label="Time Range Selector">
                        <option value="daily" selected>Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid">
        <!-- Milestone Alert -->
        <div class="toast milestone-alert align-items-center text-white bg-success" role="alert" aria-live="assertive" aria-atomic="true" id="milestoneAlert">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-trophy me-2"></i>
                    <span id="milestoneMessage">Milestone reached!</span>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>

        <!-- Summary Cards Row -->
        <div class="row mb-4 mt-3">
            <div class="col-md-3 col-sm-6 mb-3 mb-md-0">
                <div class="card dashboard-card">
                    <div class="card-body">
                        <h5 class="card-title">Total Blocks Cut</h5>
                        <h2 class="display-4" id="totalBlocks">0</h2>
                        <div class="progress mt-3">
                            <div class="progress-bar bg-primary" role="progressbar" style="width: 0%;" id="totalProgress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <p class="card-text mt-2"><small class="text-muted" id="blockChangeRate">+0% from previous period</small></p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3 mb-md-0">
                <div class="card dashboard-card">
                    <div class="card-body">
                        <h5 class="card-title">Average Per Staff</h5>
                        <h2 class="display-4" id="averageBlocks">0</h2>
                        <div class="progress mt-3">
                            <div class="progress-bar bg-success" role="progressbar" style="width: 0%;" id="averageProgress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <p class="card-text mt-2"><small class="text-muted" id="averageChangeRate">+0% from previous period</small></p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3 mb-md-0">
                <div class="card dashboard-card">
                    <div class="card-body">
                        <h5 class="card-title">Staff Count</h5>
                        <h2 class="display-4" id="staffCount">0</h2>
                        <div id="staffGoalContainer" class="mt-3">
                            <div class="d-flex justify-content-between mb-1">
                                <small>Current Staff:</small>
                                <small id="staffCountCurrent">0</small>
                            </div>
                            <div class="progress goal-progress">
                                <div class="progress-bar bg-info" role="progressbar" style="width: 0%;" id="staffProgress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                        <p class="card-text mt-2"><small class="text-muted" id="staffChangeRate">+0 from previous month</small></p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="card dashboard-card">
                    <div class="card-body">
                        <h5 class="card-title">Goal Achievement</h5>
                        <h2 class="display-4" id="goalPercentage">0%</h2>
                        <div class="progress mt-3">
                            <div class="progress-bar bg-warning" role="progressbar" style="width: 0%;" id="goalProgress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <p class="card-text mt-2"><small class="text-muted" id="goalChangeRate">+0% from previous period</small></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts and Leaderboard Row -->
        <div class="row mb-4">
            <!-- Performance Charts -->
            <div class="col-lg-8 mb-4 mb-lg-0">
                <div class="card dashboard-card">
                    <div class="card-body">
                        <ul class="nav nav-tabs" id="performanceTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="daily-tab" data-bs-toggle="tab" data-bs-target="#daily" type="button" role="tab" aria-controls="daily" aria-selected="true">Daily</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="weekly-tab" data-bs-toggle="tab" data-bs-target="#weekly" type="button" role="tab" aria-controls="weekly" aria-selected="false">Weekly</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="monthly-tab" data-bs-toggle="tab" data-bs-target="#monthly" type="button" role="tab" aria-controls="monthly" aria-selected="false">Monthly</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="yearly-tab" data-bs-toggle="tab" data-bs-target="#yearly" type="button" role="tab" aria-controls="yearly" aria-selected="false">Yearly</button>
                            </li>
                        </ul>
                        <div class="tab-content mt-3" id="performanceTabContent">
                            <div class="tab-pane fade show active" id="daily" role="tabpanel" aria-labelledby="daily-tab">
                                <canvas id="dailyChart" height="300"></canvas>
                            </div>
                            <div class="tab-pane fade" id="weekly" role="tabpanel" aria-labelledby="weekly-tab">
                                <canvas id="weeklyChart" height="300"></canvas>
                            </div>
                            <div class="tab-pane fade" id="monthly" role="tabpanel" aria-labelledby="monthly-tab">
                                <canvas id="monthlyChart" height="300"></canvas>
                            </div>
                            <div class="tab-pane fade" id="yearly" role="tabpanel" aria-labelledby="yearly-tab">
                                <canvas id="yearlyChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Leaderboard -->
            <div class="col-lg-4">
                <div class="card dashboard-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">Leaderboard</h5>
                            <select class="form-select form-select-sm w-auto" id="leaderboardTimeRange">
                                <option value="daily" selected>Today</option>
                                <option value="weekly">This Week</option>
                                <option value="monthly">This Month</option>
                                <option value="yearly">This Year</option>
                                <option value="allTime">All Time</option>
                            </select>
                        </div>
                        <div id="leaderboardContainer" class="overflow-auto" style="max-height: 300px;">
                            <!-- Leaderboard items will be populated here by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Staff Performance and Data Entry Row -->
        <div class="row mb-4">
            <!-- Staff Performance -->
            <div class="col-lg-8 mb-4 mb-lg-0">
                <div class="card dashboard-card">
                    <div class="card-body">
                        <h5 class="card-title">Staff Performance</h5>
                        <div class="table-responsive">
                            <table class="table table-hover" id="staffPerformanceTable">
                                <thead>
                                    <tr>
                                        <th>Staff Member</th>
                                        <th>Daily</th>
                                        <th>Weekly</th>
                                        <th>Monthly</th>
                                        <th>Yearly</th>
                                        <th>Goal Progress</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Staff performance rows will be populated here by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Data Entry Form -->
            <div class="col-lg-4">
                <div class="card dashboard-card">
                    <div class="card-body">
                        <h5 class="card-title">Add Block Data</h5>
                        <form id="blockEntryForm">
                            <div class="mb-3">
                                <label for="entryStaffSelect" class="form-label">Staff Member</label>
                                <select class="form-select" id="entryStaffSelect" required>
                                    <!-- Staff options will be populated here by JavaScript -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="blockCount" class="form-label">Blocks Cut</label>
                                <input type="number" class="form-control" id="blockCount" min="1" required>
                            </div>
                            <div class="mb-3">
                                <label for="entryDate" class="form-label">Date</label>
                                <input type="date" class="form-control" id="entryDate" required>
                            </div>
                            <div class="mb-3">
                                <label for="shiftSelect" class="form-label">Shift</label>
                                <select class="form-select" id="shiftSelect" required>
                                    <option value="day">Day</option>
                                </select>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Staff Management Modal -->
    <div class="modal fade" id="staffManagementModal" tabindex="-1" aria-labelledby="staffManagementModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="staffManagementModalLabel">Staff Management</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="staffManagementTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="staff-list-tab" data-bs-toggle="tab" data-bs-target="#staff-list" type="button" role="tab" aria-controls="staff-list" aria-selected="true">Staff List</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="add-staff-tab" data-bs-toggle="tab" data-bs-target="#add-staff" type="button" role="tab" aria-controls="add-staff" aria-selected="false">Add Staff</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="goal-setting-tab" data-bs-toggle="tab" data-bs-target="#goal-setting" type="button" role="tab" aria-controls="goal-setting" aria-selected="false">Set Goals</button>
                        </li>
                    </ul>
                    <div class="tab-content mt-3" id="staffManagementTabContent">
                        <div class="tab-pane fade show active" id="staff-list" role="tabpanel" aria-labelledby="staff-list-tab">
                            <div class="table-responsive">
                                <table class="table table-hover" id="staffListTable">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>ID</th>
                                            <th>Daily Goal</th>
                                            <th>Weekly Goal</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Staff list will be populated here by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="add-staff" role="tabpanel" aria-labelledby="add-staff-tab">
                            <form id="addStaffForm">
                                <div class="mb-3">
                                    <label for="staffName" class="form-label">Staff Name</label>
                                    <input type="text" class="form-control" id="staffName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="staffId" class="form-label">Staff ID</label>
                                    <input type="text" class="form-control" id="staffId" required>
                                </div>
                                <div class="mb-3">
                                    <label for="staffDailyGoal" class="form-label">Daily Block Goal</label>
                                    <input type="number" class="form-control" id="staffDailyGoal" min="1" required>
                                </div>
                                <div class="mb-3">
                                    <label for="staffWeeklyGoal" class="form-label">Weekly Block Goal</label>
                                    <input type="number" class="form-control" id="staffWeeklyGoal" min="1" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Add Staff</button>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="goal-setting" role="tabpanel" aria-labelledby="goal-setting-tab">
                            <form id="setGoalForm">
                                <div class="mb-3">
                                    <label for="goalStaffSelect" class="form-label">Select Staff Member</label>
                                    <select class="form-select" id="goalStaffSelect" required>
                                        <!-- Staff options will be populated here by JavaScript -->
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="goalType" class="form-label">Goal Type</label>
                                    <select class="form-select" id="goalType" required>
                                        <option value="daily">Daily</option>
                                        <option value="weekly">Weekly</option>
                                        <option value="monthly">Monthly</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="goalValue" class="form-label">Goal Value (blocks)</label>
                                    <input type="number" class="form-control" id="goalValue" min="1" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Set Goal</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger" id="resetDataButton">Reset All Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import/Export Modal -->
    <div class="modal fade" id="importExportModal" tabindex="-1" aria-labelledby="importExportModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="importExportModalLabel">Import/Export Data</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <h6>Export Data</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" id="exportCsvBtn">
                                <i class="fas fa-file-csv me-2"></i>Export as CSV
                            </button>
                            <button class="btn btn-outline-success" id="exportExcelBtn">
                                <i class="fas fa-file-excel me-2"></i>Export as Excel
                            </button>
                            <button class="btn btn-outline-danger" id="exportPdfBtn">
                                <i class="fas fa-file-pdf me-2"></i>Export as PDF
                            </button>
                        </div>
                    </div>
                    <div>
                        <h6>Import Data</h6>
                        <div class="mb-3">
                            <label for="importFile" class="form-label">Select File (CSV or Excel)</label>
                            <input class="form-control" type="file" id="importFile" accept=".csv,.xlsx,.xls">
                        </div>
                        <button class="btn btn-primary" id="importDataBtn">Import Data</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        // DOM Elements
        const darkModeToggle = document.getElementById('darkModeToggle');
        const mainNav = document.getElementById('mainNav');
        const staffSelector = document.getElementById('staffSelector');
        const timeRangeSelector = document.getElementById('timeRangeSelector');
        const blockEntryForm = document.getElementById('blockEntryForm');
        const entryStaffSelect = document.getElementById('entryStaffSelect');
        const addStaffForm = document.getElementById('addStaffForm');
        const setGoalForm = document.getElementById('setGoalForm');
        const goalStaffSelect = document.getElementById('goalStaffSelect');
        const resetDataButton = document.getElementById('resetDataButton');
        const leaderboardTimeRange = document.getElementById('leaderboardTimeRange');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const exportPdfBtn = document.getElementById('exportPdfBtn');
        const importDataBtn = document.getElementById('importDataBtn');
        const milestoneAlert = document.getElementById('milestoneAlert');

        // Initialize Bootstrap toast
        const milestoneToast = new bootstrap.Toast(milestoneAlert);

        // Sample initial data - this would normally be loaded from storage
        let staffData = [
            { id: 'staff1', name: 'John Doe', dailyGoal: 50, weeklyGoal: 250 },
            { id: 'staff2', name: 'Jane Smith', dailyGoal: 45, weeklyGoal: 225 },
            { id: 'staff3', name: 'Robert Johnson', dailyGoal: 55, weeklyGoal: 275 }
        ];

        // Sample block data - this would normally be loaded from storage
        let blockData = [
            { staffId: 'staff1', date: '2025-03-04', shift: 'morning', count: 48 },
            { staffId: 'staff1', date: '2025-03-05', shift: 'morning', count: 52 },
            { staffId: 'staff2', date: '2025-03-04', shift: 'afternoon', count: 43 },
            { staffId: 'staff2', date: '2025-03-05', shift: 'afternoon', count: 46 },
            { staffId: 'staff3', date: '2025-03-04', shift: 'morning', count: 54 },
            { staffId: 'staff3', date: '2025-03-05', shift: 'morning', count: 57 }
        ];

        // Chart objects
        let dailyChart, weeklyChart, monthlyChart, yearlyChart;

        // Dark mode toggle
        darkModeToggle.addEventListener('change', () => {
            document.body.classList.toggle('light-mode');
            document.body.classList.toggle('dark-mode');
            
            if (document.body.classList.contains('dark-mode')) {
                mainNav.classList.remove('navbar-light', 'bg-light');
                mainNav.classList.add('navbar-dark', 'bg-dark');
            } else {
                mainNav.classList.remove('navbar-dark', 'bg-dark');
                mainNav.classList.add('navbar-light', 'bg-light');
            }
            
            // Update charts with new theme
            updateAllCharts();
        });

        // Initialize charts
        function initializeCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            };

            // Daily Chart
            const dailyCtx = document.getElementById('dailyChart').getContext('2d');
            dailyChart = new Chart(dailyCtx, {
                type: 'bar',
                data: {
                    labels: ['Day'],
                    datasets: []
                },
                options: chartOptions
            });

            // Weekly Chart
            const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
            weeklyChart = new Chart(weeklyCtx, {
                type: 'line',
                data: {
                    labels: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'],
                    datasets: []
                },
                options: chartOptions
            });

            // Monthly Chart
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            monthlyChart = new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: Array.from({ length: 31 }, (_, i) => i + 1),
                    datasets: []
                },
                options: chartOptions
            });

            // Yearly Chart
            const yearlyCtx = document.getElementById('yearlyChart').getContext('2d');
            yearlyChart = new Chart(yearlyCtx, {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: []
                },
                options: chartOptions
            });
        }

        // Reset data for a specific staff member
        function resetStaffData(staffId) {
            const staff = staffData.find(s => s.id === staffId);
            if (!staff) return;
            
            if (confirm(`Are you sure you want to reset all data for ${staff.name}? This will delete all block entries for this staff member, but keep their profile.`)) {
                // Remove all block data for this staff
                blockData = blockData.filter(block => block.staffId !== staffId);
                
                // Save data
                saveData();
                
                // Update UI
                updateAllCharts();
                updateDashboardMetrics();
                updateStaffPerformanceTable();
                updateLeaderboard();
                
                alert(`Data for ${staff.name} has been reset.`);
            }
        }
        
        // Initialize UI elements
        function initializeUI() {
            // Set dark/light mode
            if (document.body.classList.contains('dark-mode')) {
                darkModeToggle.checked = true;
                mainNav.classList.add('navbar-dark', 'bg-dark');
            } else {
                mainNav.classList.add('navbar-light', 'bg-light');
            }

            // Set current date as default for entry form
            document.getElementById('entryDate').valueAsDate = new Date();

            // Populate staff selectors
            populateStaffSelectors();
            
            // Populate staff table
            updateStaffTable();
            
            // Update leaderboard
            updateLeaderboard();
            
            // Update performance metrics
            updateDashboardMetrics();
            
            // Update staff performance table
            updateStaffPerformanceTable();
        }

        // Populate all staff selection dropdowns
        function populateStaffSelectors() {
            // Clear existing options except 'All Staff'
            while (staffSelector.options.length > 1) {
                staffSelector.remove(1);
            }
            
            // Clear entry staff select completely
            entryStaffSelect.innerHTML = '';
            goalStaffSelect.innerHTML = '';
            
            // Add staff options to all selectors
            staffData.forEach(staff => {
                // Main staff selector
                const option1 = document.createElement('option');
                option1.value = staff.id;
                option1.textContent = staff.name;
                staffSelector.appendChild(option1);
                
                // Entry form staff selector
                const option2 = document.createElement('option');
                option2.value = staff.id;
                option2.textContent = staff.name;
                entryStaffSelect.appendChild(option2);
                
                // Goal setting staff selector
                const option3 = document.createElement('option');
                option3.value = staff.id;
                option3.textContent = staff.name;
                goalStaffSelect.appendChild(option3);
            });
        }

        // Update the staff table in the modal
        function updateStaffTable() {
            const tableBody = document.querySelector('#staffListTable tbody');
            tableBody.innerHTML = '';
            
            staffData.forEach(staff => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${staff.name}</td>
                    <td>${staff.id}</td>
                    <td>${staff.dailyGoal}</td>
                    <td>${staff.weeklyGoal}</td>
                    <td>
                        <button class="btn btn-sm btn-warning edit-staff" data-id="${staff.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger delete-staff" data-id="${staff.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="btn btn-sm btn-secondary reset-staff-data" data-id="${staff.id}" title="Reset staff data">
                            <i class="fas fa-redo-alt"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-staff').forEach(button => {
                button.addEventListener('click', function() {
                    const staffId = this.getAttribute('data-id');
                    deleteStaff(staffId);
                });
            });
            
            // Add event listeners to edit buttons
            document.querySelectorAll('.edit-staff').forEach(button => {
                button.addEventListener('click', function() {
                    const staffId = this.getAttribute('data-id');
                    editStaff(staffId);
                });
            });
            
            // Add event listeners to reset staff data buttons
            document.querySelectorAll('.reset-staff-data').forEach(button => {
                button.addEventListener('click', function() {
                    const staffId = this.getAttribute('data-id');
                    resetStaffData(staffId);
                });
            });
            
            // Add event listeners to reset staff data buttons
            document.querySelectorAll('.reset-staff-data').forEach(button => {
                button.addEventListener('click', function() {
                    const staffId = this.getAttribute('data-id');
                    resetStaffData(staffId);
                });
            });
        }

        // Add new staff member
        function addStaff(name, id, dailyGoal, weeklyGoal) {
            // Check if ID already exists
            if (staffData.some(staff => staff.id === id)) {
                alert('Staff ID already exists. Please use a unique ID.');
                return false;
            }
            
            // Add new staff member
            staffData.push({
                id: id,
                name: name,
                dailyGoal: parseInt(dailyGoal),
                weeklyGoal: parseInt(weeklyGoal)
            });
            
            // Save data
            saveData();
            
            // Update UI
            populateStaffSelectors();
            updateStaffTable();
            updateDashboardMetrics();
            
            return true;
        }

        // Edit staff member
        function editStaff(staffId) {
            const staff = staffData.find(s => s.id === staffId);
            if (!staff) return;
            
            // Create a modal for editing
            const modal = document.createElement('div');
            modal.innerHTML = `
                <div class="modal fade" id="editStaffModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Edit Staff</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="editStaffForm">
                                    <div class="mb-3">
                                        <label for="editStaffName" class="form-label">Staff Name</label>
                                        <input type="text" class="form-control" id="editStaffName" value="${staff.name}" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="editStaffId" class="form-label">Staff ID (cannot change)</label>
                                        <input type="text" class="form-control" id="editStaffId" value="${staff.id}" disabled>
                                    </div>
                                    <div class="mb-3">
                                        <label for="editStaffDailyGoal" class="form-label">Daily Block Goal</label>
                                        <input type="number" class="form-control" id="editStaffDailyGoal" value="${staff.dailyGoal}" min="1" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="editStaffWeeklyGoal" class="form-label">Weekly Block Goal</label>
                                        <input type="number" class="form-control" id="editStaffWeeklyGoal" value="${staff.weeklyGoal}" min="1" required>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="saveEditBtn">Save Changes</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Show the modal
            const modalElement = document.getElementById('editStaffModal');
            const editModal = new bootstrap.Modal(modalElement);
            editModal.show();
            
            // Handle save button
            document.getElementById('saveEditBtn').addEventListener('click', function() {
                const name = document.getElementById('editStaffName').value;
                const dailyGoal = document.getElementById('editStaffDailyGoal').value;
                const weeklyGoal = document.getElementById('editStaffWeeklyGoal').value;
                
                // Update staff data
                const staffIndex = staffData.findIndex(s => s.id === staffId);
                staffData[staffIndex].name = name;
                staffData[staffIndex].dailyGoal = parseInt(dailyGoal);
                staffData[staffIndex].weeklyGoal = parseInt(weeklyGoal);
                
                // Save data
                saveData();
                
                // Update UI
                populateStaffSelectors();
                updateStaffTable();
                updateDashboardMetrics();
                updateStaffPerformanceTable();
                
                // Close modal
                editModal.hide();
                setTimeout(() => {
                    modalElement.remove();
                }, 500);
            });
            
            // Remove modal from DOM when hidden
            modalElement.addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }

        // Delete staff member
        function deleteStaff(staffId) {
            if (!confirm(`Are you sure you want to delete this staff member? All their data will be permanently removed.`)) {
                return;
            }
            
            // Remove staff from data
            staffData = staffData.filter(staff => staff.id !== staffId);
            
            // Remove associated block data
            blockData = blockData.filter(block => block.staffId !== staffId);
            
            // Save data
            saveData();
            
            // Update UI
            populateStaffSelectors();
            updateStaffTable();
            updateAllCharts();
            updateDashboardMetrics();
            updateStaffPerformanceTable();
            updateLeaderboard();
        }

        // Update leaderboard based on selected time range
        function updateLeaderboard() {
            const timeRange = leaderboardTimeRange.value;
            const leaderboardContainer = document.getElementById('leaderboardContainer');
            leaderboardContainer.innerHTML = '';
            
            // Get filtered data based on time range
            const filteredData = getFilteredData(timeRange);
            
            // Calculate total blocks per staff
            const staffTotals = {};
            
            filteredData.forEach(block => {
                if (!staffTotals[block.staffId]) {
                    staffTotals[block.staffId] = 0;
                }
                staffTotals[block.staffId] += block.count;
            });
            
            // Convert to array and sort
            const leaderboardData = Object.keys(staffTotals).map(staffId => {
                const staff = staffData.find(s => s.id === staffId);
                return {
                    id: staffId,
                    name: staff ? staff.name : 'Unknown',
                    total: staffTotals[staffId]
                };
            }).sort((a, b) => b.total - a.total);
            
            // Create leaderboard items
            leaderboardData.forEach((item, index) => {
                const leaderboardItem = document.createElement('div');
                leaderboardItem.className = 'leaderboard-item';
                
                let medal = '';
                if (index === 0) medal = '<i class="fas fa-medal text-warning me-2"></i>';
                else if (index === 1) medal = '<i class="fas fa-medal text-secondary me-2"></i>';
                else if (index === 2) medal = '<i class="fas fa-medal text-danger me-2"></i>';
                
                leaderboardItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            ${medal}${index + 1}. ${item.name}
                        </div>
                        <div class="fw-bold">${item.total}</div>
                    </div>
                    <div class="progress mt-1" style="height: 5px;">
                        <div class="progress-bar" role="progressbar" style="width: ${index === 0 ? 100 : (item.total / leaderboardData[0].total) * 100}%"></div>
                    </div>
                `;
                
                leaderboardContainer.appendChild(leaderboardItem);
            });
            
            // Show message if no data
            if (leaderboardData.length === 0) {
                leaderboardContainer.innerHTML = '<div class="text-center text-muted">No data available</div>';
            }
        }

        // Filter data based on time range
        function getFilteredData(timeRange, specificStaffId = null) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const startDate = new Date(today);
            
            switch (timeRange) {
                case 'daily':
                    // Today only
                    break;
                case 'weekly':
                    // Start from Monday of current week
                    startDate.setDate(today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1));
                    break;
                case 'monthly':
                    // Start from 1st of current month
                    startDate.setDate(1);
                    break;
                case 'yearly':
                    // Start from January 1st of current year
                    startDate.setMonth(0, 1);
                    break;
                case 'allTime':
                    // No filtering by date
                    return specificStaffId ? 
                        blockData.filter(block => block.staffId === specificStaffId) : 
                        blockData;
                default:
                    break;
            }
            
            // Filter by date and staff if specified
            return blockData.filter(block => {
                const blockDate = new Date(block.date);
                const dateMatches = blockDate >= startDate && blockDate <= today;
                const staffMatches = specificStaffId ? block.staffId === specificStaffId : true;
                return dateMatches && staffMatches;
            });
        }

        // Update all charts with current data
        function updateAllCharts() {
            updateDailyChart();
            updateWeeklyChart();
            updateMonthlyChart();
            updateYearlyChart();
        }

        // Update daily chart
        function updateDailyChart() {
            const selectedStaff = staffSelector.value;
            const datasets = [];
            
            // Get today's date string
            const today = new Date().toISOString().split('T')[0];
            
            if (selectedStaff === 'all') {
                // Group data by staff
                const staffGroups = {};
                
                staffData.forEach(staff => {
                    const staffBlocks = blockData.filter(block => 
                        block.staffId === staff.id && block.date === today
                    );
                    
                    const dayCount = staffBlocks.filter(block => block.shift === 'day')
                        .reduce((sum, block) => sum + block.count, 0);
                    
                    staffGroups[staff.id] = {
                        name: staff.name,
                        data: [dayCount]
                    };
                });
                
                // Create dataset for each staff
                Object.values(staffGroups).forEach((staff, index) => {
                    const colorIndex = index % chartColors.length;
                    datasets.push({
                        label: staff.name,
                        data: staff.data,
                        backgroundColor: chartColors[colorIndex],
                        borderColor: chartColors[colorIndex],
                        borderWidth: 1
                    });
                });
            } else {
                // Filter data for selected staff and today
                const staffBlocks = blockData.filter(block => 
                    block.staffId === selectedStaff && block.date === today
                );
                
                const dayCount = staffBlocks.filter(block => block.shift === 'day')
                    .reduce((sum, block) => sum + block.count, 0);
                
                const staff = staffData.find(s => s.id === selectedStaff) || { name: 'Unknown' };
                
                datasets.push({
                    label: staff.name,
                    data: [dayCount],
                    backgroundColor: chartColors[0],
                    borderColor: chartColors[0],
                    borderWidth: 1
                });
            }
            
            // Update chart
            dailyChart.data.datasets = datasets;
            dailyChart.update();
        }

        // Update weekly chart
        function updateWeeklyChart() {
            const selectedStaff = staffSelector.value;
            const datasets = [];
            
            // Get dates for current week (Monday to Sunday)
            const today = new Date();
            const currentDay = today.getDay(); // 0 is Sunday, 1 is Monday, etc.
            const monday = new Date(today);
            monday.setDate(today.getDate() - (currentDay === 0 ? 6 : currentDay - 1));
            monday.setHours(0, 0, 0, 0);
            
            const weekDates = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                weekDates.push(date.toISOString().split('T')[0]);
            }
            
            if (selectedStaff === 'all') {
                // Create a dataset for each staff
                staffData.forEach((staff, staffIndex) => {
                    const dailyCounts = weekDates.map(date => {
                        const dayBlocks = blockData.filter(block => 
                            block.staffId === staff.id && block.date === date
                        );
                        return dayBlocks.reduce((sum, block) => sum + block.count, 0);
                    });
                    
                    const colorIndex = staffIndex % chartColors.length;
                    datasets.push({
                        label: staff.name,
                        data: dailyCounts,
                        backgroundColor: chartColors[colorIndex],
                        borderColor: chartColors[colorIndex],
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    });
                });
            } else {
                // Create a dataset for the selected staff
                const staff = staffData.find(s => s.id === selectedStaff);
                if (staff) {
                    const dailyCounts = weekDates.map(date => {
                        const dayBlocks = blockData.filter(block => 
                            block.staffId === staff.id && block.date === date
                        );
                        return dayBlocks.reduce((sum, block) => sum + block.count, 0);
                    });
                    
                    datasets.push({
                        label: staff.name,
                        data: dailyCounts,
                        backgroundColor: chartColors[0],
                        borderColor: chartColors[0],
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    });
                }
            }
            
            // Update chart
            weeklyChart.data.datasets = datasets;
            weeklyChart.update();
        }

        // Update monthly chart
        function updateMonthlyChart() {
            const selectedStaff = staffSelector.value;
            const datasets = [];
            
            // Get current month dates
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const monthDates = [];
            for (let i = 1; i <= daysInMonth; i++) {
                const date = new Date(year, month, i);
                monthDates.push(date.toISOString().split('T')[0]);
            }
            
            if (selectedStaff === 'all') {
                // Create a dataset for each staff
                staffData.forEach((staff, staffIndex) => {
                    const dailyCounts = monthDates.map(date => {
                        const dayBlocks = blockData.filter(block => 
                            block.staffId === staff.id && block.date === date
                        );
                        return dayBlocks.reduce((sum, block) => sum + block.count, 0);
                    });
                    
                    const colorIndex = staffIndex % chartColors.length;
                    datasets.push({
                        label: staff.name,
                        data: dailyCounts,
                        backgroundColor: chartColors[colorIndex],
                        borderColor: chartColors[colorIndex],
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    });
                });
            } else {
                // Create a dataset for the selected staff
                const staff = staffData.find(s => s.id === selectedStaff);
                if (staff) {
                    const dailyCounts = monthDates.map(date => {
                        const dayBlocks = blockData.filter(block => 
                            block.staffId === staff.id && block.date === date
                        );
                        return dayBlocks.reduce((sum, block) => sum + block.count, 0);
                    });
                    
                    datasets.push({
                        label: staff.name,
                        data: dailyCounts,
                        backgroundColor: chartColors[0],
                        borderColor: chartColors[0],
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    });
                }
            }
            
            // Update chart labels to show only day numbers
            monthlyChart.data.labels = Array.from({ length: daysInMonth }, (_, i) => i + 1);
            monthlyChart.data.datasets = datasets;
            monthlyChart.update();
        }

        // Update yearly chart
        function updateYearlyChart() {
            const selectedStaff = staffSelector.value;
            const datasets = [];
            
            // Get current year
            const today = new Date();
            const year = today.getFullYear();
            
            // Create month date ranges
            const monthRanges = [];
            for (let month = 0; month < 12; month++) {
                const startDate = new Date(year, month, 1);
                const endDate = new Date(year, month + 1, 0);
                monthRanges.push({
                    start: startDate.toISOString().split('T')[0],
                    end: endDate.toISOString().split('T')[0]
                });
            }
            
            if (selectedStaff === 'all') {
                // Create a dataset for each staff
                staffData.forEach((staff, staffIndex) => {
                    const monthlyCounts = monthRanges.map(range => {
                        const monthBlocks = blockData.filter(block => {
                            const blockDate = block.date;
                            return block.staffId === staff.id && 
                                   blockDate >= range.start && 
                                   blockDate <= range.end;
                        });
                        return monthBlocks.reduce((sum, block) => sum + block.count, 0);
                    });
                    
                    const colorIndex = staffIndex % chartColors.length;
                    datasets.push({
                        label: staff.name,
                        data: monthlyCounts,
                        backgroundColor: chartColors[colorIndex],
                        borderColor: chartColors[colorIndex],
                        borderWidth: 1
                    });
                });
            } else {
                // Create a dataset for the selected staff
                const staff = staffData.find(s => s.id === selectedStaff);
                if (staff) {
                    const monthlyCounts = monthRanges.map(range => {
                        const monthBlocks = blockData.filter(block => {
                            const blockDate = block.date;
                            return block.staffId === staff.id && 
                                   blockDate >= range.start && 
                                   blockDate <= range.end;
                        });
                        return monthBlocks.reduce((sum, block) => sum + block.count, 0);
                    });
                    
                    datasets.push({
                        label: staff.name,
                        data: monthlyCounts,
                        backgroundColor: chartColors[0],
                        borderColor: chartColors[0],
                        borderWidth: 1
                    });
                }
            }
            
            // Update chart
            yearlyChart.data.datasets = datasets;
            yearlyChart.update();
        }

        // Update all dashboard metrics
        function updateDashboardMetrics() {
            const timeRange = timeRangeSelector.value;
            const filteredData = getFilteredData(timeRange);
            
            // Total blocks
            const totalBlocks = filteredData.reduce((sum, block) => sum + block.count, 0);
            document.getElementById('totalBlocks').textContent = totalBlocks.toLocaleString();
            
            // Staff count
            const staffCount = staffData.length;
            document.getElementById('staffCount').textContent = staffCount;
            document.getElementById('staffCountCurrent').textContent = staffCount;
            
            // Average blocks per staff
            const averageBlocks = staffCount > 0 ? Math.round(totalBlocks / staffCount) : 0;
            document.getElementById('averageBlocks').textContent = averageBlocks.toLocaleString();
            
            // Goal percentage
            let totalGoals = 0;
            let achievedGoals = 0;
            
            staffData.forEach(staff => {
                const staffBlocks = filteredData.filter(block => block.staffId === staff.id);
                const staffTotal = staffBlocks.reduce((sum, block) => sum + block.count, 0);
                
                let staffGoal;
                switch (timeRange) {
                    case 'daily':
                        staffGoal = staff.dailyGoal;
                        break;
                    case 'weekly':
                        staffGoal = staff.weeklyGoal;
                        break;
                    case 'monthly':
                        staffGoal = staff.weeklyGoal * 4;
                        break;
                    case 'yearly':
                        staffGoal = staff.weeklyGoal * 52;
                        break;
                    default:
                        staffGoal = staff.dailyGoal;
                }
                
                totalGoals += staffGoal;
                achievedGoals += Math.min(staffTotal, staffGoal);
            });
            
            const goalPercentage = totalGoals > 0 ? Math.round((achievedGoals / totalGoals) * 100) : 0;
            document.getElementById('goalPercentage').textContent = `${goalPercentage}%`;
            document.getElementById('goalProgress').style.width = `${goalPercentage}%`;
            document.getElementById('goalProgress').setAttribute('aria-valuenow', goalPercentage);
            
            // Progress bars
            document.getElementById('totalProgress').style.width = '75%';
            document.getElementById('totalProgress').setAttribute('aria-valuenow', 75);
            
            document.getElementById('averageProgress').style.width = '60%';
            document.getElementById('averageProgress').setAttribute('aria-valuenow', 60);
            
            document.getElementById('staffProgress').style.width = '80%';
            document.getElementById('staffProgress').setAttribute('aria-valuenow', 80);
        }

        // Update staff performance table
        function updateStaffPerformanceTable() {
            const tableBody = document.querySelector('#staffPerformanceTable tbody');
            tableBody.innerHTML = '';
            
            staffData.forEach(staff => {
                // Get performance data for different time periods
                const dailyData = getFilteredData('daily', staff.id);
                const weeklyData = getFilteredData('weekly', staff.id);
                const monthlyData = getFilteredData('monthly', staff.id);
                const yearlyData = getFilteredData('yearly', staff.id);
                
                const dailyTotal = dailyData.reduce((sum, block) => sum + block.count, 0);
                const weeklyTotal = weeklyData.reduce((sum, block) => sum + block.count, 0);
                const monthlyTotal = monthlyData.reduce((sum, block) => sum + block.count, 0);
                const yearlyTotal = yearlyData.reduce((sum, block) => sum + block.count, 0);
                
                // Calculate goal progress
                const dailyGoalPercent = staff.dailyGoal > 0 ? Math.min(100, Math.round((dailyTotal / staff.dailyGoal) * 100)) : 0;
                const weeklyGoalPercent = staff.weeklyGoal > 0 ? Math.min(100, Math.round((weeklyTotal / staff.weeklyGoal) * 100)) : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${staff.name}</td>
                    <td>${dailyTotal} / ${staff.dailyGoal}</td>
                    <td>${weeklyTotal} / ${staff.weeklyGoal}</td>
                    <td>${monthlyTotal}</td>
                    <td>${yearlyTotal}</td>
                    <td>
                        <div class="progress">
                            <div class="progress-bar bg-success" role="progressbar" 
                                style="width: ${dailyGoalPercent}%;" 
                                aria-valuenow="${dailyGoalPercent}" aria-valuemin="0" aria-valuemax="100">
                                ${dailyGoalPercent}%
                            </div>
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // Save data to local storage
        function saveData() {
            localStorage.setItem('histologyStaffData', JSON.stringify(staffData));
            localStorage.setItem('histologyBlockData', JSON.stringify(blockData));
        }

        // Load data from local storage
        function loadData() {
            const savedStaffData = localStorage.getItem('histologyStaffData');
            const savedBlockData = localStorage.getItem('histologyBlockData');
            
            if (savedStaffData) {
                staffData = JSON.parse(savedStaffData);
            }
            
            if (savedBlockData) {
                blockData = JSON.parse(savedBlockData);
            }
        }

        // Add block data
        function addBlockData(staffId, count, date, shift) {
            blockData.push({
                staffId,
                date,
                shift,
                count: parseInt(count)
            });
            
            // Check for milestone
            const staff = staffData.find(s => s.id === staffId);
            const staffDailyTotal = blockData
                .filter(block => block.staffId === staffId && block.date === date)
                .reduce((sum, block) => sum + block.count, 0);
            
            if (staff && staffDailyTotal >= staff.dailyGoal && staffDailyTotal - count < staff.dailyGoal) {
                // Show milestone alert
                document.getElementById('milestoneMessage').textContent = 
                    `${staff.name} has reached their daily goal of ${staff.dailyGoal} blocks!`;
                milestoneToast.show();
            }
            
            // Save data
            saveData();
            
            // Update UI
            updateAllCharts();
            updateDashboardMetrics();
            updateStaffPerformanceTable();
            updateLeaderboard();
        }

        // Export data as CSV
        function exportAsCSV() {
            // Create CSV content
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Headers
            csvContent += "Staff ID,Staff Name,Date,Shift,Block Count\n";
            
            // Data rows
            blockData.forEach(block => {
                const staff = staffData.find(s => s.id === block.staffId) || { name: 'Unknown' };
                csvContent += `${block.staffId},${staff.name},${block.date},${block.shift},${block.count}\n`;
            });
            
            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "histology_blocks_data.csv");
            document.body.appendChild(link);
            
            // Trigger download
            link.click();
            
            // Clean up
            document.body.removeChild(link);
        }

        // Export data as Excel (simplified version using CSV)
        function exportAsExcel() {
            // For this simplified version, we'll use CSV format with .xlsx extension
            // In a real-world scenario, you'd want to use a library like SheetJS
            
            // Create CSV content
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Headers
            csvContent += "Staff ID,Staff Name,Date,Shift,Block Count\n";
            
            // Data rows
            blockData.forEach(block => {
                const staff = staffData.find(s => s.id === block.staffId) || { name: 'Unknown' };
                csvContent += `${block.staffId},${staff.name},${block.date},${block.shift},${block.count}\n`;
            });
            
            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "histology_blocks_data.xlsx");
            document.body.appendChild(link);
            
            // Trigger download
            link.click();
            
            // Clean up
            document.body.removeChild(link);
        }

        // Export data as PDF
        function exportAsPDF() {
            alert("PDF export functionality would typically require a PDF generation library. In a real implementation, you would use libraries like jsPDF or browser's print-to-PDF functionality.");
            
            // Create a printable version
            const printWindow = window.open('', '_blank');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Histology Blocks Data</title>
                    <style>
                        body { font-family: Arial, sans-serif; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        h1, h2 { color: #333; }
                    </style>
                </head>
                <body>
                    <h1>Histology Blocks Data</h1>
                    <h2>Generated on ${new Date().toLocaleDateString()}</h2>
                    
                    <h3>Staff Summary</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Staff ID</th>
                                <th>Name</th>
                                <th>Daily Goal</th>
                                <th>Weekly Goal</th>
                            </tr>
                        </thead>
                        <tbody>
            `);
            
            staffData.forEach(staff => {
                printWindow.document.write(`
                    <tr>
                        <td>${staff.id}</td>
                        <td>${staff.name}</td>
                        <td>${staff.dailyGoal}</td>
                        <td>${staff.weeklyGoal}</td>
                    </tr>
                `);
            });
            
            printWindow.document.write(`
                        </tbody>
                    </table>
                    
                    <h3>Block Data</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Staff</th>
                                <th>Date</th>
                                <th>Shift</th>
                                <th>Blocks Cut</th>
                            </tr>
                        </thead>
                        <tbody>
            `);
            
            blockData.forEach(block => {
                const staff = staffData.find(s => s.id === block.staffId) || { name: 'Unknown' };
                printWindow.document.write(`
                    <tr>
                        <td>${staff.name}</td>
                        <td>${block.date}</td>
                        <td>${block.shift}</td>
                        <td>${block.count}</td>
                    </tr>
                `);
            });
            
            printWindow.document.write(`
                        </tbody>
                    </table>
                    
                    <p><em>Please use browser's print function to save as PDF.</em></p>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            
            // Suggest printing
            setTimeout(() => {
                printWindow.print();
            }, 1000);
        }

        // Import data
        function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file to import.');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const contents = e.target.result;
                
                try {
                    // Assuming CSV format
                    const rows = contents.split('\n');
                    const headers = rows[0].split(',');
                    
                    // Skip the header row
                    const dataRows = rows.slice(1);
                    
                    // Temporary storage for imported data
                    const importedStaff = [];
                    const importedBlocks = [];
                    
                    // Process each row
                    dataRows.forEach(row => {
                        if (!row.trim()) return; // Skip empty rows
                        
                        const columns = row.split(',');
                        const staffId = columns[0].trim();
                        const staffName = columns[1].trim();
                        const date = columns[2].trim();
                        const shift = columns[3].trim();
                        const count = parseInt(columns[4].trim());
                        
                        // Add staff if not already in importedStaff
                        if (!importedStaff.some(s => s.id === staffId)) {
                            importedStaff.push({
                                id: staffId,
                                name: staffName,
                                dailyGoal: 50, // Default values
                                weeklyGoal: 250
                            });
                        }
                        
                        // Add block data
                        importedBlocks.push({
                            staffId,
                            date,
                            shift,
                            count
                        });
                    });
                    
                    // Merge with existing data or replace
                    if (confirm('Do you want to merge this data with existing data? Click Cancel to replace all data.')) {
                        // Merge staff data
                        importedStaff.forEach(importedStaffMember => {
                            if (!staffData.some(s => s.id === importedStaffMember.id)) {
                                staffData.push(importedStaffMember);
                            }
                        });
                        
                        // Merge block data
                        blockData = blockData.concat(importedBlocks);
                    } else {
                        // Replace all data
                        staffData = importedStaff;
                        blockData = importedBlocks;
                    }
                    
                    // Save and update UI
                    saveData();
                    populateStaffSelectors();
                    updateStaffTable();
                    updateAllCharts();
                    updateDashboardMetrics();
                    updateStaffPerformanceTable();
                    updateLeaderboard();
                    
                    alert('Data imported successfully!');
                } catch (error) {
                    console.error('Error importing data:', error);
                    alert('Error importing data. Please check file format.');
                }
            };
            
            reader.readAsText(file);
        }

        // Reset data for a specific staff member
        function resetStaffData(staffId) {
            const staff = staffData.find(s => s.id === staffId);
            if (!staff) return;
            
            if (confirm(`Are you sure you want to reset all data for ${staff.name}? This will delete all block entries for this staff member, but keep their profile.`)) {
                // Remove all block data for this staff
                blockData = blockData.filter(block => block.staffId !== staffId);
                
                // Save data
                saveData();
                
                // Update UI
                updateAllCharts();
                updateDashboardMetrics();
                updateStaffPerformanceTable();
                updateLeaderboard();
                
                alert(`Data for ${staff.name} has been reset.`);
            }
        }
        
        // Reset all data
        function resetData() {
            if (confirm('Are you sure you want to reset all data? This action cannot be undone.')) {
                // Clear local storage
                localStorage.removeItem('histologyStaffData');
                localStorage.removeItem('histologyBlockData');
                
                // Reset to sample data
                staffData = [
                    { id: 'staff1', name: 'John Doe', dailyGoal: 50, weeklyGoal: 250 },
                    { id: 'staff2', name: 'Jane Smith', dailyGoal: 45, weeklyGoal: 225 },
                    { id: 'staff3', name: 'Robert Johnson', dailyGoal: 55, weeklyGoal: 275 }
                ];
                
                blockData = [
                    { staffId: 'staff1', date: '2025-03-04', shift: 'morning', count: 48 },
                    { staffId: 'staff1', date: '2025-03-05', shift: 'morning', count: 52 },
                    { staffId: 'staff2', date: '2025-03-04', shift: 'afternoon', count: 43 },
                    { staffId: 'staff2', date: '2025-03-05', shift: 'afternoon', count: 46 },
                    { staffId: 'staff3', date: '2025-03-04', shift: 'morning', count: 54 },
                    { staffId: 'staff3', date: '2025-03-05', shift: 'morning', count: 57 }
                ];
                
                // Update UI
                populateStaffSelectors();
                updateStaffTable();
                updateAllCharts();
                updateDashboardMetrics();
                updateStaffPerformanceTable();
                updateLeaderboard();
                
                alert('All data has been reset to sample data.');
            }
        }

        // Chart colors
        const chartColors = [
            'rgba(75, 192, 192, 0.7)',
            'rgba(54, 162, 235, 0.7)',
            'rgba(255, 159, 64, 0.7)',
            'rgba(255, 99, 132, 0.7)',
            'rgba(153, 102, 255, 0.7)',
            'rgba(255, 205, 86, 0.7)',
            'rgba(201, 203, 207, 0.7)'
        ];

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize UI
            initializeCharts();
            
            // Load saved data
            loadData();
            
            // Initialize UI with loaded data
            initializeUI();
            
            // Update charts
            updateAllCharts();
            
            // Add event listeners
            staffSelector.addEventListener('change', function() {
                updateAllCharts();
            });
            
            timeRangeSelector.addEventListener('change', function() {
                updateDashboardMetrics();
                updateStaffPerformanceTable();
            });
            
            leaderboardTimeRange.addEventListener('change', function() {
                updateLeaderboard();
            });
            
            // Block entry form
            blockEntryForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const staffId = entryStaffSelect.value;
                const count = parseInt(document.getElementById('blockCount').value);
                const date = document.getElementById('entryDate').value;
                const shift = document.getElementById('shiftSelect').value;
                
                addBlockData(staffId, count, date, shift);
                
                // Reset form
                document.getElementById('blockCount').value = '';
                
                alert('Block data added successfully!');
            });
            
            // Add staff form
            addStaffForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const name = document.getElementById('staffName').value;
                const id = document.getElementById('staffId').value;
                const dailyGoal = document.getElementById('staffDailyGoal').value;
                const weeklyGoal = document.getElementById('staffWeeklyGoal').value;
                
                if (addStaff(name, id, dailyGoal, weeklyGoal)) {
                    // Reset form
                    document.getElementById('staffName').value = '';
                    document.getElementById('staffId').value = '';
                    document.getElementById('staffDailyGoal').value = '';
                    document.getElementById('staffWeeklyGoal').value = '';
                    
                    alert('Staff member added successfully!');
                }
            });
            
            // Set goal form
            setGoalForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const staffId = goalStaffSelect.value;
                const goalType = document.getElementById('goalType').value;
                const goalValue = parseInt(document.getElementById('goalValue').value);
                
                const staffIndex = staffData.findIndex(s => s.id === staffId);
                
                if (staffIndex !== -1) {
                    if (goalType === 'daily') {
                        staffData[staffIndex].dailyGoal = goalValue;
                    } else if (goalType === 'weekly') {
                        staffData[staffIndex].weeklyGoal = goalValue;
                    }
                    
                    // Save data
                    saveData();
                    
                    // Update UI
                    updateStaffTable();
                    updateDashboardMetrics();
                    updateStaffPerformanceTable();
                    
                    alert('Goal updated successfully!');
                }
            });
            
            // Reset data button
            resetDataButton.addEventListener('click', resetData);
            
            // Export buttons
            exportCsvBtn.addEventListener('click', exportAsCSV);
            exportExcelBtn.addEventListener('click', exportAsExcel);
            exportPdfBtn.addEventListener('click', exportAsPDF);
            
            // Import button
            importDataBtn.addEventListener('click', importData);
            
            // Tab event listeners for charts
            document.getElementById('daily-tab').addEventListener('shown.bs.tab', function() {
                updateDailyChart();
            });
            
            document.getElementById('weekly-tab').addEventListener('shown.bs.tab', function() {
                updateWeeklyChart();
            });
            
            document.getElementById('monthly-tab').addEventListener('shown.bs.tab', function() {
                updateMonthlyChart();
            });
            
            document.getElementById('yearly-tab').addEventListener('shown.bs.tab', function() {
                updateYearlyChart();
            });
        });
    </script>
</body>
</html>
